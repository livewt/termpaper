vec2 <- c(0.100, 0.106, 0.109, 0)
pe2 <- plot(vec2, ylab = "% Endring i ReducedRatio", xlab = "Bins", main = "Tabell 7 Kolonne 2 med FE Bedrift", xaxt ="n")+
lines(vec2)+
Axis(side =1, at = 1:5)
vec3 <- c(0.100, 0.106, 0.109, 0)
pe3 <- plot(vec3, ylab = "% Endring i ReducedRatio", xlab = "Bins", main = "Tabell 7 Kolonne 3 med FE Tid+Bedrift", xaxt ="n")+
lines(vec3)+
Axis(side =1, at = 1:5)
library(XML)
library(tidyverse)
library(taRifx)
library(bit64)
library(magrittr)
choose_file <- choose.files(caption ="Select your SAF-T file (xml format)")
#making DF from saf-t xml file
main <- xmlParse(choose_file)
#or choose automatic (for testing purposes)
main <- xmlParse("SAF-T Telenor 2019 (fictious).xml")
namespace <- xmlNamespaceDefinitions(main)[1]
namespace[[1]][1] == "nl"
namespace <- as.character(namespace[[1]][1])
namespace <- paste("//", namespace, sep = "", ":Account")
main_df <- xmlToDataFrame(nodes = getNodeSet(main, namespace))
#removing "helping account"
main_df <- main_df %>%
filter(AccountDescription!="Hjelpekonto")
#vektor1 contais account IDS from SAF-T file
dataframe_check_STD <- data.frame(main_df$StandardAccountID) %>%
remove.factors(.)
vektor1 <- character()
for (chr in dataframe_check_STD){
vektor1 <- c(vektor1, chr)
}
vektor1 <- vektor1 %>% unique()
#importing specification from skatteetaten
STD_accounts_check <- xmlParse("General_Ledger_Standard_Accounts_2_character.xml")
STD_accounts_check_df <- xmlToDataFrame(nodes = getNodeSet(STD_accounts_check, "//AccountID")) %>%
remove.factors(.)
skatteetaten_unique <- unique(STD_accounts_check_df$text)
vektor2 <- character()
setwd("~/termpaper")
#or choose automatic (for testing purposes)
main <- xmlParse("SAF-T Telenor 2019 (fictious).xml")
namespace <- xmlNamespaceDefinitions(main)[1]
namespace[[1]][1] == "nl"
namespace <- as.character(namespace[[1]][1])
namespace <- paste("//", namespace, sep = "", ":Account")
main_df <- xmlToDataFrame(nodes = getNodeSet(main, namespace))
#removing "helping account"
main_df <- main_df %>%
filter(AccountDescription!="Hjelpekonto")
#vektor1 contais account IDS from SAF-T file
dataframe_check_STD <- data.frame(main_df$StandardAccountID) %>%
remove.factors(.)
vektor1 <- character()
for (chr in dataframe_check_STD){
vektor1 <- c(vektor1, chr)
}
vektor1 <- vektor1 %>% unique()
#importing specification from skatteetaten
STD_accounts_check <- xmlParse("General_Ledger_Standard_Accounts_2_character.xml")
STD_accounts_check_df <- xmlToDataFrame(nodes = getNodeSet(STD_accounts_check, "//AccountID")) %>%
remove.factors(.)
skatteetaten_unique <- unique(STD_accounts_check_df$text)
vektor2 <- character()
#adding IDs to vektor 2 if IDs from our data is in the specification by skatteetaten
for (i in 1:length(skatteetaten_unique)){
if (vektor1[i] %in% skatteetaten_unique){
vektor2 <- c(vektor2, vektor1[i])
}
}
#making sure IDs from our data is equal to the IDS by skatteetaten
#Giving error message if its not true
for (i in 1:length(vektor1)){
if (vektor2[i] != vektor1[i]){
print("Your SAF-T file is not compatible with this program")
}
}
#base "as.integer()" has max value of +/-2*10^9. Base integer convert decimal right e.g "0.0" to 0
#"as.integer64()" has higher max value, but converts decimal chr to NA's. E.G "0.0" to NA
#Function to remove decimal from chr and return the "as.integer64" of it to do calcs later on
#Even on numbers exeeding 2*10^9
#Fixed problem with rounding!
charToInt64 <- function(s){
stopifnot( is.character(s) )
x <- character() #placeholder for the number
y <- character() #placeholder for the decimals
z <- list()
for (i in s){
z <- c(z, strsplit(i, "\\D")) #splits , and . and adds to list
}
for (i in z){ #for every first element add to x (e.g 10.1, then 10 will be added)
x <- c(x, i[[1]])
x <- as.integer64(x)
if(!is.na(i[2])){ #Checks if there is a split (decimal)
y <- c(y, i[[2]])
}
else {
y <- c(y,0) #adds 0 as decimal if not
}
}
for (i in 1:length(x)){ #checks if the first chr of the decimal is >= 5 for rounding
if (substr(y[i],1,1) >=5){
x[i] <- x[i]+1
}
}
x #return the number
}
#test
testvektor <- c("0.0", "0", "10", "20000000000", "0.011", "1.1", "4,5") #last one should be rounded
charToInt64(testvektor)
#finally no bugs with numbers
#unfinshed code to start working on calculating fincancial numbers
#Converting chr to integer64 for all balances
main_df$OpeningDebitBalance <- charToInt64(main_df$OpeningDebitBalance)
main_df$OpeningCreditBalance <- charToInt64(main_df$OpeningCreditBalance)
main_df$ClosingDebitBalance <- charToInt64(main_df$ClosingDebitBalance)
main_df$ClosingCreditBalance <- charToInt64(main_df$ClosingCreditBalance)
#Functions to make financial figures calculations!
#Function to subset main_df based on standard account ID for Opening balance for assets (IDs 10-19)
Open_asset_func <- function (std_id){
a <- subset(main_df, main_df$AccountID==std_id) #subsetting standard acc ID
rownames(a) <- NULL #resetting rows
b <- sum(a$OpeningDebitBalance) - sum(a$OpeningCreditBalance)
b
}
#same but with closing blanace
Close_asset_func <- function (std_id){
a <- subset(main_df, main_df$StandardAccountID==std_id) #subsetting standard acc ID
rownames(a) <- NULL #resetting rows
b <- sum(a$ClosingDebitBalance) - sum(a$ClosingCreditBalance)
b
}
#Function to subset main_df on standard acc IDs for opening balance for equity, liabilites and income/loss
Open_credit_func <- function (std_id){
a <- subset(main_df, main_df$StandardAccountID==std_id) #subsetting standard acc ID
rownames(a) <- NULL #resetting rows
b <- sum(a$OpeningCreditBalance) - sum(a$OpeningDebitBalance)
b
}
#Same with closing balance
Close_credit_func <- function (std_id){
a <- subset(main_df, main_df$StandardAccountID==std_id) #subsetting standard acc ID
rownames(a) <- NULL #resetting rows
b <- sum(a$ClosingCreditBalance) - sum(a$ClosingDebitBalance)
b
}
#Function to sum accounts with different account IDS for Opening balance IDs 10-19 (Assets)
Sum_Open_asset_func <- function(start, end){
x <- integer64()
for (i in start:end){
x <- c(x, Open_asset_func(i)) #uses the subset function above
}
x <- sum(x)
x
}
#same but for closing balance
Sum_Close_asset_func <- function(start, end){
x <- integer64()
for (i in start:end){
x <- c(x, Close_asset_func(i)) #uses the subset function above
}
x <- sum(x)
x
}
#function to sum all OPENING balance with ID from 20 and beyond for equity,liability and income/loss
Sum_Open_credit_func <- function(start, end){
x <- integer64()
for (i in start:end){
x <- c(x, Open_credit_func(i)) #uses the subset function above
}
x <- sum(x)
x
}
#Same but for CLOSING balance for ids 20 and beyond
Sum_Close_credit_func <- function(start, end){
x <- integer64()
for (i in start:end){
x <- c(x, Close_credit_func(i)) #uses the subset function above
}
x <- sum(x)
x
}
Sum_Open_asset_func(6000, 6070)
3900000000+47000000
Sum_Open_asset_func(6000, 6070)
clear
Sum_Open_asset_func(6000, 6070)
library(shiny); runApp('shinydashboard_test.R')
install.packages("docstring")
install.packages("devtools")
runApp('shinydashboard_test.R')
library(shiny); runApp('shinydashboard_test.R')
library(XML)
library(tidyverse)
library(taRifx)
library(bit64)
library(magrittr)
library(docstring)
library(devtools)
choose_file <- choose.files(caption ="Select your SAF-T file (xml format)")
#making DF from saf-t xml file
main <- xmlParse(choose_file)
#or choose automatic (for testing purposes)
main <- xmlParse("SAF-T Telenor 2019 (fictious).xml")
namespace <- xmlNamespaceDefinitions(main)[1]
namespace[[1]][1] == "nl"
namespace <- as.character(namespace[[1]][1])
namespace <- paste("//", namespace, sep = "", ":Account")
main_df <- xmlToDataFrame(nodes = getNodeSet(main, namespace))
#removing "helping account"
main_df <- main_df %>%
filter(AccountDescription!="Hjelpekonto")
#vektor1 contais account IDS from SAF-T file
dataframe_check_STD <- data.frame(main_df$StandardAccountID) %>%
remove.factors(.)
vektor1 <- character()
for (chr in dataframe_check_STD){
vektor1 <- c(vektor1, chr)
}
vektor1 <- vektor1 %>% unique()
#importing specification from skatteetaten
STD_accounts_check <- xmlParse("General_Ledger_Standard_Accounts_2_character.xml")
STD_accounts_check_df <- xmlToDataFrame(nodes = getNodeSet(STD_accounts_check, "//AccountID")) %>%
remove.factors(.)
skatteetaten_unique <- unique(STD_accounts_check_df$text)
vektor2 <- character()
#adding IDs to vektor 2 if IDs from our data is in the specification by skatteetaten
for (i in 1:length(skatteetaten_unique)){
if (vektor1[i] %in% skatteetaten_unique){
vektor2 <- c(vektor2, vektor1[i])
}
}
#making sure IDs from our data is equal to the IDS by skatteetaten
#Giving error message if its not true
for (i in 1:length(vektor1)){
if (vektor2[i] != vektor1[i]){
print("Your SAF-T file is not compatible with this program")
}
}
#base "as.integer()" has max value of +/-2*10^9. Base integer convert decimal right e.g "0.0" to 0
#"as.integer64()" has higher max value, but converts decimal chr to NA's. E.G "0.0" to NA
#Function to remove decimal from chr and return the "as.integer64" of it to do calcs later on
#Even on numbers exeeding 2*10^9
#Fixed problem with rounding!
charToInt64 <- function(s){
#' Convert char elements in vector into int64
#'
#' Removes decimal(s), rounds and converts to closest integer64
#'
#'
#' @param s the vector to be converted
#'
stopifnot( is.character(s) )
x <- character() #placeholder for the number
y <- character() #placeholder for the decimals
z <- list()
for (i in s){
z <- c(z, strsplit(i, "\\D")) #splits , and . and adds to list
}
for (i in z){ #for every first element add to x (e.g 10.1, then 10 will be added)
x <- c(x, i[[1]])
x <- as.integer64(x)
if(!is.na(i[2])){ #Checks if there is a split (decimal)
y <- c(y, i[[2]])
}
else {
y <- c(y,0) #adds 0 as decimal if not
}
}
for (i in 1:length(x)){ #checks if the first chr of the decimal is >= 5 for rounding
if (substr(y[i],1,1) >=5){
x[i] <- x[i]+1
}
}
x #return the number
}
#test
testvektor <- c("0.0", "0", "10", "20000000000", "0.011", "1.1", "4,5") #last one should be rounded
charToInt64(testvektor)
docstring(charToInt64)
?charToInt64
#finally no bugs with numbers
#unfinshed code to start working on calculating fincancial numbers
#Converting chr to integer64 for all balances
main_df$OpeningDebitBalance <- charToInt64(main_df$OpeningDebitBalance)
main_df$OpeningCreditBalance <- charToInt64(main_df$OpeningCreditBalance)
main_df$ClosingDebitBalance <- charToInt64(main_df$ClosingDebitBalance)
main_df$ClosingCreditBalance <- charToInt64(main_df$ClosingCreditBalance)
#Functions to make financial figures calculations!
#Function to subset main_df based on standard account ID for Opening balance for assets (IDs 10-19)
Open_asset_func <- function (std_id){
#' Output opening balance for assets
#'
#' Subsets main_df based on standard account ID for Opening balance for assets. Returns the sum of subset$OpeningDebitBalance minus the sum of subset$OpeningCreditBalance
#'
#' @param std_id the standard account ID(s) for opening balance for assets
#'
a <- subset(main_df, main_df$StandardAccountID==std_id) #subsetting standard acc ID
rownames(a) <- NULL #resetting rows
b <- sum(a$OpeningDebitBalance) - sum(a$OpeningCreditBalance)
b
}
View(main_df)
library(XML)
library(tidyverse)
library(taRifx)
library(bit64)
#for example 3yrs old
choose_file <- choose.files(caption ="Select your SAF-T file (xml format)")
#for example 3yrs old
choose_file <- choose.files(caption ="Select your SAF-T file (xml format)")
main <- xmlParse("saf-t example (3yrs old).xml") #placeholder to skip choosing manually
list <-
xmlToList(main)
main_list <- xmlToList(main)
test <- as.data.frame(list[[3]][[4]][[4]])
test <- list[[3]][[4]] %>%
map_df(~as.data.frame(.))
sum <- test[ ,grepl("Line.Amount", names(test))]
sum <- sum %>%
map_df(as.numeric)
sum[is.na(sum)] <- 0
sum <- sum %>%
mutate(Sum = rowSums(.)) %>%
mutate(Amounts = Sum/2)
test <- cbind(test, sum$Amounts)
mva_test <- test%>%
select(Description, TransactionID,`sum$Amounts`)
#mva_test <- mva_test %>%
# drop_na(Line.TaxInformation.TaxType)
mva_test <- mva_test %>%
drop_na(TransactionID)
mva_test2 <- mva_test$`sum$Amounts` %>%
as.numeric()
mva_test2 <- as.data.frame(mva_test2)
mva_test2$mva_test22 <- mva_test2$mva_test2
mva_test %>%
head
#For colouring purposes?
wssplot <- function(data, nc=15, seed=1234){ #function found online!!!
wss <- (nrow(data)-1)*sum(apply(data,2,var))
for (i in 2:nc){
set.seed(seed)
wss[i] <- sum(kmeans(data, centers=i)$withinss)}
plot(1:nc, wss, type="b", xlab="Number of Clusters",
ylab="Within groups sum of squares")
wss
}
wssplot(mva_test2)
cluster_amount <- as.numeric(readline(prompt = "How many clusters do you want? "))
KM$betweenss
KM$centers
#install.packages("ggiraph")
library(ggiraph)
mva_test$cluster <- as.character(KM$cluster)
#mva_test$Line.Amount.1 <- as.numeric(mva_test$Line.Amount.1)
mva_test$TransactionID <- as.numeric(mva_test$TransactionID)
tooltip_ <- c(paste0("Description: ", mva_test$Description, "\n Transaction ID: = ", mva_test$TransactionID, "\n Amount: ", mva_test$`sum$Amounts`, " NOK"))
testplot <- ggplot(data = mva_test) +
geom_point_interactive(aes(x = 1:length(`sum$Amounts`), y = `sum$Amounts`, color = cluster,
tooltip = tooltip_, data_id = TransactionID))+
ylab("Transcation amount")+
xlab("Transcations")+
ggtitle("Hover over points to view description of the transcation")+
scale_x_continuous(labels = scales::comma)+
scale_y_continuous(labels = scales::comma)
testplot
#girafe(code = print(testplot))
girafe(ggobj = testplot)
#check if all transcations are included (53 in this case)
as.numeric(list[[3]][[1]]) == length(mva_test$`sum$Amounts`)
#check if sum of transcations is right
sum(mva_test$`sum$Amounts`)== as.numeric(list[[3]][[2]])
library(XML)
library(tidyverse)
library(taRifx)
library(bit64)
main <- xmlParse("saf-t example (3yrs old).xml") #placeholder to skip choosing manually
list <-
xmlToList(main)
main_list <- xmlToList(main)
test <- as.data.frame(list[[3]][[4]][[4]])
test <- list[[3]][[4]] %>%
map_df(~as.data.frame(.))
sum <- test[ ,grepl("Line.Amount", names(test))]
sum <- sum %>%
map_df(as.numeric)
sum[is.na(sum)] <- 0
sum <- sum %>%
mutate(Sum = rowSums(.)) %>%
mutate(Amounts = Sum/2)
test <- cbind(test, sum$Amounts)
mva_test <- test%>%
select(Description, TransactionID,`sum$Amounts`)
#mva_test <- mva_test %>%
# drop_na(Line.TaxInformation.TaxType)
mva_test <- mva_test %>%
drop_na(TransactionID)
mva_test2 <- mva_test$`sum$Amounts` %>%
as.numeric()
mva_test2 <- as.data.frame(mva_test2)
mva_test2$mva_test22 <- mva_test2$mva_test2
mva_test %>%
head
#For colouring purposes?
wssplot <- function(data, nc=15, seed=1234){ #function found online!!!
wss <- (nrow(data)-1)*sum(apply(data,2,var))
for (i in 2:nc){
set.seed(seed)
wss[i] <- sum(kmeans(data, centers=i)$withinss)}
plot(1:nc, wss, type="b", xlab="Number of Clusters",
ylab="Within groups sum of squares")
wss
}
wssplot(mva_test2)
cluster_amount <- as.numeric(readline(prompt = "How many clusters do you want? "))
KM$betweenss
KM$centers
#install.packages("ggiraph")
library(ggiraph)
mva_test$cluster <- as.character(KM$cluster)
#mva_test$Line.Amount.1 <- as.numeric(mva_test$Line.Amount.1)
mva_test$TransactionID <- as.numeric(mva_test$TransactionID)
tooltip_ <- c(paste0("Description: ", mva_test$Description, "\n Transaction ID: = ", mva_test$TransactionID, "\n Amount: ", mva_test$`sum$Amounts`, " NOK"))
testplot <- ggplot(data = mva_test) +
geom_point_interactive(aes(x = 1:length(`sum$Amounts`), y = `sum$Amounts`, color = cluster,
tooltip = tooltip_, data_id = TransactionID))+
ylab("Transcation amount")+
xlab("Transcations")+
ggtitle("Hover over points to view description of the transcation")+
scale_x_continuous(labels = scales::comma)+
scale_y_continuous(labels = scales::comma)
testplot
#girafe(code = print(testplot))
girafe(ggobj = testplot)
#check if all transcations are included (53 in this case)
as.numeric(list[[3]][[1]]) == length(mva_test$`sum$Amounts`)
View(mva_test2)
library(XML)
library(tidyverse)
library(taRifx)
library(bit64)
main <- xmlParse("saf-t example (3yrs old).xml") #placeholder to skip choosing manually
list <-
xmlToList(main)
main_list <- xmlToList(main)
test <- as.data.frame(list[[3]][[4]][[4]])
test <- list[[3]][[4]] %>%
map_df(~as.data.frame(.))
sum <- test[ ,grepl("Line.Amount", names(test))]
sum <- sum %>%
map_df(as.numeric)
sum[is.na(sum)] <- 0
sum <- sum %>%
mutate(Sum = rowSums(.)) %>%
mutate(Amounts = Sum/2)
test <- cbind(test, sum$Amounts)
mva_test <- test%>%
select(Description, TransactionID,`sum$Amounts`)
#mva_test <- mva_test %>%
# drop_na(Line.TaxInformation.TaxType)
mva_test <- mva_test %>%
drop_na(TransactionID)
mva_test2 <- mva_test$`sum$Amounts` %>%
as.numeric()
mva_test2 <- as.data.frame(mva_test2)
mva_test2$mva_test22 <- mva_test2$mva_test2
mva_test %>%
head
#For colouring purposes?
wssplot <- function(data, nc=15, seed=1234){ #function found online!!!
wss <- (nrow(data)-1)*sum(apply(data,2,var))
for (i in 2:nc){
set.seed(seed)
wss[i] <- sum(kmeans(data, centers=i)$withinss)}
plot(1:nc, wss, type="b", xlab="Number of Clusters",
ylab="Within groups sum of squares")
wss
}
wssplot(mva_test2)
cluster_amount <- as.numeric(readline(prompt = "How many clusters do you want? "))
cluster_amount <- as.numeric(readline(prompt = "How many clusters do you want? "))
KM = kmeans(mva_test2, cluster_amount)
KM$betweenss
KM$centers
#install.packages("ggiraph")
library(ggiraph)
mva_test$cluster <- as.character(KM$cluster)
#mva_test$Line.Amount.1 <- as.numeric(mva_test$Line.Amount.1)
mva_test$TransactionID <- as.numeric(mva_test$TransactionID)
tooltip_ <- c(paste0("Description: ", mva_test$Description, "\n Transaction ID: = ", mva_test$TransactionID, "\n Amount: ", mva_test$`sum$Amounts`, " NOK"))
testplot <- ggplot(data = mva_test) +
geom_point_interactive(aes(x = 1:length(`sum$Amounts`), y = `sum$Amounts`, color = cluster,
tooltip = tooltip_, data_id = TransactionID))+
ylab("Transcation amount")+
xlab("Transcations")+
ggtitle("Hover over points to view description of the transcation")+
scale_x_continuous(labels = scales::comma)+
scale_y_continuous(labels = scales::comma)
testplot
#girafe(code = print(testplot))
girafe(ggobj = testplot)
View(mva_test)
View(sum)
View(test)
library(shiny); runApp('shinydashboard_test.R')
runApp('shinydashboard_test.R')
runApp('shinydashboard_test.R')
runApp('shinydashboard_test.R')
library(shiny); runApp('shinydashboard_test.R')
runApp('shinydashboard_test.R')
